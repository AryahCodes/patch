{% extends "base.html" %}
{% block title %}Landlord Chat{% endblock %}
{% block content %}
  <h2>Landlord Chat Room</h2>
  <!-- Dropdown to select an attached tenant -->
  <div class="form-group">
    <label for="tenantSelect">Select Tenant:</label>
    <select id="tenantSelect" class="form-control">
      <option value="">-- Select tenant --</option>
      {% for tenant in tenants %}
        <option value="{{ tenant.uid }}">{{ tenant.email }}</option>
      {% endfor %}
    </select>
  </div>
  
  <!-- Chat Section: initially hidden -->
  <div id="chat-section" style="display:none;">
    <div id="chat-window" style="height:400px; border:1px solid #ddd; overflow-y:auto; padding:10px;"></div>
    <div class="input-group mt-3">
      <input id="chat-message-input" type="text" class="form-control" placeholder="Type your message..." />
      <div class="input-group-append">
        <button id="image-upload-btn" class="btn btn-outline-secondary" title="Send Image">
          <i class="fas fa-image"></i>
        </button>
        <button id="chat-send-btn" class="btn btn-primary">Send</button>
      </div>
    </div>
    <!-- Hidden file input for image upload -->
    <input type="file" id="hidden-image-upload" accept="image/*" style="display:none;">
  </div>
{% endblock %}
{% block scripts %}
<script>
  var socket = io();
  var currentChatId = "";

  // When the landlord selects a tenant from the dropdown.
  document.getElementById('tenantSelect').addEventListener('change', function() {
    var tenantUid = this.value;
    if (tenantUid === "") {
      document.getElementById('chat-section').style.display = "none";
      return;
    }
    // Generate chat room ID by concatenating landlord's UID and the selected tenant's UID.
    var landlordUid = "{{ session['uid'] }}";
    currentChatId = landlordUid + "_" + tenantUid;
    
    // Show the chat section.
    document.getElementById('chat-section').style.display = "block";
    
    // Join the chat room.
    socket.emit('join_chat', { 'chat_id': currentChatId });
    
    // Load the last 10 messages.
    loadChatMessages(currentChatId);
  });

  function loadChatMessages(chatId) {
    fetch('/load_chat/' + chatId)
      .then(response => response.json())
      .then(data => {
        var chatWindow = document.getElementById('chat-window');
        chatWindow.innerHTML = "";
        data.messages.forEach(function(msg) {
          var div = document.createElement('div');
          if (msg.type === "image") {
            div.innerHTML = "<strong>" + msg.sender + ":</strong><br><img src='" + msg.message + "' style='max-width:200px;' />";
          } else {
            div.innerHTML = "<strong>" + msg.sender + ":</strong> " + msg.message;
          }
          chatWindow.appendChild(div);
        });
        chatWindow.scrollTop = chatWindow.scrollHeight;
      });
  }

  // Listen for live chat messages.
  socket.on('chat_message', function(data) {
    if (data.chat_id === currentChatId) {
      var chatWindow = document.getElementById('chat-window');
      var div = document.createElement('div');
      if (data.type === "image") {
        div.innerHTML = "<strong>" + data.sender + ":</strong><br><img src='" + data.message + "' style='max-width:200px;' />";
      } else {
        div.innerHTML = "<strong>" + data.sender + ":</strong> " + data.message;
      }
      chatWindow.appendChild(div);
      chatWindow.scrollTop = chatWindow.scrollHeight;
    }
  });

  // Send text message.
  document.getElementById('chat-send-btn').addEventListener('click', function() {
    var input = document.getElementById('chat-message-input');
    var message = input.value;
    if (message.trim() !== "" && currentChatId !== "") {
      socket.emit('send_chat_message', {
        'chat_id': currentChatId,
        'sender': "{{ session['username'] }}",
        'message': message,
        'type': "text"
      });
      input.value = "";
    }
  });

  document.getElementById('chat-message-input').addEventListener('keydown', function(e) {
    if (e.key === "Enter") {
      document.getElementById('chat-send-btn').click();
      e.preventDefault();
    }
  });
  
  // Image upload handling.
  document.getElementById('image-upload-btn').addEventListener('click', function(){
    document.getElementById('hidden-image-upload').click();
  });
  
  document.getElementById('hidden-image-upload').addEventListener('change', function(event){
    var file = event.target.files[0];
    if (file) {
      var formData = new FormData();
      formData.append('file', file);
      fetch('/upload_image?chat_id=' + currentChatId, {
        method: 'POST',
        body: formData
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          socket.emit('send_chat_message', {
            'chat_id': currentChatId,
            'sender': "{{ session['username'] }}",
            'message': data.image_url,
            'type': "image"
          });
        }
      });
    }
  });
</script>
{% endblock %}
